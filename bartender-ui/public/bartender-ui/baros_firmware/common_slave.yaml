
esphome: 
    name: baros-slave
    on_boot:
      - priority: -100.0
        then:
          - binary_sensor.template.publish:
              id: clean_system_slave
              state: false
          - binary_sensor.template.publish:
              id: pi_started_slave
              state: false
          - delay: 3s
          - light.turn_on: led_rgb2

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf
    version: recommended









binary_sensor:
  - platform: packet_transport
    name: Wifi Status
    provider: baros
    remote_id: wifi_status_main
    internal: false
    id: wifi_status


  - platform: packet_transport
    name: Server Status
    provider: baros
    remote_id: server_status_main
    internal: false
    id: server_status

  - platform: template
    name: PI Started
    id: pi_started_slave
    on_press:
      - then:
          - script.execute:
              id: send_to_pi
              module: 0xFF
              data1: 0
              data2: 0

  - platform: packet_transport
    name: Recipe Pouring
    provider: baros
    remote_id: pouring
    internal: false
    on_press:
      - script.execute:
          id: send_to_pi
          module: 0 
          data1: 2
          data2: 1
    on_release:
      - script.execute:
          id: send_to_pi
          module: 0
          data1: 2
          data2: 0
  - platform: template
    name: Clean System
    id: clean_system_slave

scprit:
  - id: update_all_tank_status
    mode: single
    then:
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 1
          data2: !lambda "return id(tank1_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 2
          data2: !lambda "return id(tank2_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 3
          data2: !lambda "return id(tank3_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 4
          data2: !lambda "return id(tank4_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 5
          data2: !lambda "return id(tank5_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 6
          data2: !lambda "return id(tank6_slave).state;"
      - script.execute:
          id: send_to_pi
          module: 1
          data1: 7
          data2: !lambda "return id(tank7_slave).state;"
          
  - id: send_to_pi
    mode: queued
    parameters:
      module: uint8_t
      data1: uint16_t
      data2: uint16_t
    then:
      - logger.log:
          format: "Sending to PI: module=%d, data1=%d, data2=%d"
          level: INFO
          args:
            - module
            - data1
            - data2
      - delay: 100ms
      - lambda: |-
          uint8_t frame[8] = {
            0x0f, 0x00, 
            module,
            (uint8_t)((data1 >> 8) & 0xff),
            (uint8_t)(data1 & 0xff),
            (uint8_t)((data2 >> 8) & 0xff),
            (uint8_t)(data2 & 0xff),
            0xAA
          };
          id(uart_pi).write_array(frame, 8);



  - id: update_connection_status
    mode: single
    then:
      - script.execute:
          id: send_to_pi
          module: 0x00
          data1: 0x3
          data2: !lambda "return id(wifi_status).state;"
      - script.execute:
          id: send_to_pi
          module: 0x00
          data1: 0x04
          data2: !lambda "return id(server_status).state;"




button:
  - platform: template
    name: Test UART
    on_press:
      then:
        - logger.log: "Test UART"
        - script.execute:
            id: send_to_pi
            module: 1
            data1: 3
            data2: 0

  - platform: template
    name: Test MP4
    on_press: 
      then:
        - script.execute:
            id: send_to_pi
            module: 0 
            data1: 2
            data2: 1
        - delay: 5s
        - script.execute:
            id: send_to_pi
            module: 0
            data1: 2
            data2: 0

interval:
  - interval: 30s
    then:
      - script.execute: update_all_tank_status
    
  - interval: 10s
    then:
      - binary_sensor.template.publish:
          id: wifi_status
          state: 'false'
      - binary_sensor.template.publish:
          id: server_status
          state: 'false'
      - delay: 2s
      - script.execute: update_connection_status