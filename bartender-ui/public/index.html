<!-- è°ƒé…’æœºå±å¹• Web App (720Ã—720 åœ†å±ï¼ŒåŒé¡µé¢å·¦å³æ»‘åŠ¨) -->
<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
  <meta name="google" content="notranslate">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>è°ƒé…’æœºå±å¹•</title>
  <style>
    :root{
      --diameter: 100vmin;
      --fg:#E8DBFF; --fg-dim:#B8A6DF; --fg-weak:#7E6FB1; --accent:#A78BFA;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;background:#000;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei","Noto Sans CJK SC",sans-serif;color:var(--fg)}
    .stage{height:100%;display:grid;place-items:center}
    .watch{
      position:relative;
      width:var(--diameter);
      height:var(--diameter);
      border-radius:50%;
      overflow:hidden;
      user-select:none;
      background:url('./assets/home.png') center/cover no-repeat;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      opacity:0;                    /* åˆå§‹éšè—ï¼Œå¾…å¯åŠ¨è§†é¢‘ç»“æŸåæ·¡å…¥ */
      transition:opacity .6s ease-out;
    }
    .carousel{display:flex;height:100%;width:calc(2 * var(--diameter));transition:transform .42s cubic-bezier(.22,.61,.36,1)}
    .page{position:relative;flex:0 0 var(--diameter);height:100%}

    .title{position:absolute;top:12%;left:50%;transform:translateX(-50%);font-size:clamp(36px,3.6vmin,28px);font-weight:700;letter-spacing:.3px;text-shadow:0 2px 10px rgba(0,0,0,.35)}

    .bottles{
      position:absolute;
      left:50%;
      top:45%;                           /* â† ä¸­å¿ƒç‚¹åœ¨å±å¹•æ­£ä¸­ */
      transform:translate(-50%,-50%);    /* â† ä»¥è‡ªèº«ä¸­å¿ƒå¯¹é½ */
      width:86%;
      display:flex;
      justify-content:space-between;
      gap:1.6%;
      flex-direction: row;
    }
    .bottles.reverse {
        flex-direction: row-reverse;
    }

    /* å¯é€‰ï¼šè®©ç“¶å­åº•éƒ¨åœ¨åŒä¸€åŸºçº¿ã€è§†è§‰æ›´æ•´é½ */
    .bottle{
      width:calc(100%/7 - .1vmin);
      aspect-ratio:1/3.2;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center bottom;  /* â† åº•å¯¹é½ï¼Œé€šå¸¸æ›´å¥½çœ‹ */
      opacity:.95;
      filter:drop-shadow(0 6px 8px rgba(0,0,0,.35));
    }
    .bottle.full{background-image:url('./assets/bottle_full.png')}
    .bottle.empty{background-image:url('./assets/bottle_empty.png');opacity:.35}

    .waterTank{
      position:absolute;
      left:50%;
      bottom:22%;          /* â† åŸ14%ï¼Œä¸Šç§»ä¸€äº›ã€‚ä½ å¯æŒ‰è§†è§‰å¾®è°ƒä¸º 20~25% */
      transform:translateX(-50%);
      width:64px;
      height:64px;
      /* border-radius:20px; */
      /* border:1px solid rgba(232,219,255,.35); */
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.0));
      display:grid;
      place-items:center;
      backdrop-filter:blur(6px);
      cursor:pointer;
      transition:.2s;
    }
    .waterTank img{width:28px;height:28px;opacity:.9}

  .panel{
    padding: 18% 12% 14%;   /* åŸå…ˆå¤§æ¦‚ 14%/12%/12% â†’ é¡¶éƒ¨åŠ å¤§ã€åº•éƒ¨ä¹ŸåŠ ä¸€ç‚¹ */
    display: flex;
    flex-direction: column;
    gap: 18px;              /* æŒ‰é’®ä¸åˆ—è¡¨ä¹‹é—´åŠ é—´è· */
    max-width: 78%;
    margin: 0 auto;
  } 



/* ===== å¸ƒå±€ä¸ç•™ç™½ ===== */
/* ===== å¸ƒå±€ä¸ç•™ç™½ï¼ˆæ›´åƒç›®æ ‡å›¾ï¼‰ ===== */

  /* è®©è®¾ç½®é¡µæ•´ä½“æ›´é ä¸­é—´ï¼Œå·¦å³ç•™ç™½èˆ’é€‚ */
  /* .panel{
    padding: 14% 11% 12%;
    max-width: 78%;
    margin: 0 auto;
  } */

  /* ===== è‡ªæ¸…æ´ï¼šå±…ä¸­å¤§èƒ¶å›ŠæŒ‰é’®ï¼ˆæ›´æ¥è¿‘ç›®æ ‡å›¾é£æ ¼ï¼‰ ===== */
  .btn-xl{
    display:flex; align-items:center; justify-content:center;
    height:56px; width:100%;
    margin: 10px auto 18px;
    align-self: flex-end;   /* ä¿æŒåœ¨å³ä¾§ */
    margin-bottom: 6px;     /* æŒ‰é’®ä¸‹æ–¹å†ç•™ç‚¹æ°”å£ */
    border-radius: 999px;
    font-weight: 700; letter-spacing:.3px; color:#fff;
    background:
      radial-gradient(120% 160% at 50% 0%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
    border:1px solid rgba(232,219,255,.35);
    box-shadow: 0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
    text-shadow: 0 2px 10px rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
  }
  .btn-xl img{ width:20px; height:20px; margin-right:10px; opacity:.95 }
/* hover é«˜äº® */
  .btn-xl:hover {
    background: linear-gradient(180deg, #b39cff 0%, #9a84f8 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(167,139,250,0.5);
  }

  /* active ç‚¹å‡»å‹ä¸‹æ•ˆæœ */
  .btn-xl:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.4) inset;
    background: linear-gradient(180deg, #8d73ff 0%, #6f57e8 100%);
  }

  /* ===== åˆ—è¡¨è¡Œï¼šå·¦å›¾æ ‡+æ–‡å­—ï¼Œå³å¯¹é½æ•°å€¼ï¼›ç¬¬äºŒè¡Œæ˜¯slider ===== */
  .list{
    margin-top: 6px;        /* åˆ—è¡¨æ•´ä½“å¾€ä¸‹æŒªä¸€ç‚¹ */
    display: flex;
    flex-direction: column;
    gap: 22px;              /* è¡Œè·æ›´å¤§ï¼Œæ•´é¡µæ›´â€œé“ºâ€ */
  }

  .row{
    display:grid;
    grid-template-columns: auto 1fr auto; /* å›¾æ ‡ä¸æ ‡é¢˜ | å¼¹æ€§ç©ºç™½ | å³å€¼/å¼€å…³ */
    grid-template-rows: auto auto;        /* ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œç¬¬äºŒè¡Œslider */
    align-items:center;
    gap: 6px 12px;
    padding: 6px 0;
    row-gap: 10px;          /* ç¬¬ä¸€è¡Œæ–‡æœ¬ ä¸ ç¬¬äºŒè¡Œ slider çš„å‚ç›´é—´è· */
    min-height: 56px;       /* è®©æ²¡æœ‰ slider çš„è¡Œï¼ˆFridge/LEDï¼‰ä¹Ÿæ›´é«˜ä¸€äº› */
  }
  .row .label{
    grid-column:1; grid-row:1;
    display:flex; align-items:center; gap:8px;
    font-weight:600;
  }
  .row .label img{ width:20px; height:20px; opacity:.9 }
  .row .val{
    grid-column:3; grid-row:1;
    justify-self:end; font-weight:600; white-space:nowrap;
  }
  /* slider å æ»¡ç¬¬äºŒè¡Œ */
  .row input[type='range']{
    grid-column: 1 / 4;
    grid-row: 2;
    margin-top: 10px;
  }

/* ===== Sliderï¼šå·¦ç™½å³ç° + æ˜æ˜¾çš„åœ†å½¢æ»‘å— ===== */
/* ===== Sliderï¼šå·¦ç™½å³ç° + åœ†é’®ä¸è¢«è£ ===== */
  :root{ --slider-h: 8px; --thumb: 22px; }

  /* è½¨é“ç”»åœ¨â€œå†…å®¹ç›’å­â€ä¸­ï¼Œæ§ä»¶æ•´ä½“é«˜åº¦=åœ†é’®é«˜åº¦ */
  input[type='range']{
    -webkit-appearance:none; appearance:none;
    width:100%;
    height: var(--thumb);                         /* é«˜åº¦ç»™ thumb */
    padding: calc((var(--thumb) - var(--slider-h)) / 2) 0;  /* å‚ç›´å†…è¾¹è·=è®©è½¨é“å±…ä¸­ */
    background:
      linear-gradient(90deg, #fff 0 var(--p,50%),
                            rgba(255,255,255,.22) var(--p,50%) 100%);
    background-clip: content-box;                 /* åªåœ¨å†…å®¹åŒºç»˜åˆ¶è½¨é“ */
    border-radius: 999px;
    outline: none;
    overflow: visible;                             /* ç¡®ä¿ä¸è£å‰ª thumb */
    cursor: pointer;
    transition: background .2s;
  }

  /* WebKit */
  input[type='range']::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width: var(--thumb); height: var(--thumb);
    border-radius:50%;
    background:#fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.4), inset 0 0 4px rgba(255,255,255,.6);
    /* ä¸è¦å†ç”¨ margin-topï¼›padding å·²ç»è®©è½¨é“å±…ä¸­ */
    cursor: grab; transition: transform .15s ease;
  }
  input[type='range']::-webkit-slider-thumb:active{ transform: scale(1.12); cursor: grabbing; }

  /* Firefoxï¼šæŠŠè½¨é“ä¹Ÿè®¾æˆåŒæ ·çš„èƒŒæ™¯ä¸åœ†è§’ */
  input[type='range']::-moz-range-track{
    height: var(--slider-h);
    background:
      linear-gradient(90deg, #fff 0 var(--p,50%),
                            rgba(255,255,255,.22) var(--p,50%) 100%);
    border-radius: 999px;
  }
  input[type='range']::-moz-range-thumb{
    width: var(--thumb); height: var(--thumb);
    border:none; border-radius:50%; background:#fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.4), inset 0 0 4px rgba(255,255,255,.6);
    cursor: grab; transition: transform .15s ease;
  }
  input[type='range']::-moz-range-thumb:active{ transform: scale(1.12); }

  /* ä¿æŒä¸¤ç«¯åœ†è§’ */
  /* input[type='range'] { clip-path: inset(0 round 999px); } */


  /* ===== Switchï¼šå°å·§ iOS é£ï¼Œå…³=ç°ï¼Œå¼€=ç´«ï¼Œç™½è‰²åœ†ç‚¹ ===== */
  .row .switch{
    grid-column: 3;     /* æ”¾åˆ°ç¬¬3åˆ— */
    grid-row: 1;        /* ç¬¬ä¸€è¡Œ */
    justify-self: end;
    align-self: center; /* å‚ç›´å±…ä¸­ï¼ˆé˜²æ­¢åä¸Š/åä¸‹ï¼‰ */
    width: 56px;             /* åŸ 36px â†’ æ›´å®½ */
    height: 30px;            /* åŸ 20~22px â†’ æ›´é«˜ */
    border-radius: 999px;
    background: rgba(255,255,255,.22);
    border: 1px solid rgba(255,255,255,.28);
    position: relative;
    transition: background .2s;
  }

  .switch::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 3px;
    transform: translateY(-50%);
    width: 24px;             /* åœ†ç‚¹æ›´å¤§ */
    height: 24px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.35);
    transition: left .25s cubic-bezier(.4, .1, .2, 1);
  }

  .switch.on {
    background: linear-gradient(180deg, #a58bfa, #8b74e8);
  }

  .switch.on::after {
    left: 29px;              /* æ ¹æ®å®½åº¦é‡æ–°å¯¹é½ */
  }

  /* ç¡®ä¿å¼€å…³åœ¨å³ä¾§å¯¹é½ */

  /* åº•éƒ¨é¡µç ç‚¹è·åº•ç¨ä¸Š */
  .dots{ position:absolute; left:50%; transform:translateX(-50%); bottom:7%; display:flex; gap:8px; }
  .dot{ width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.25) }
  .dot.active{ background:#a78bfa }


  /* ===== Status bar: WiFi + Server icons (top-right) ===== */
  .statusBar{
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top:5%;
    display:flex;
    gap:12px;
    align-items:center;
    z-index: 5;
  }
  .status{
    width:15px; height:15px;
    transition: opacity .2s ease;
    opacity: 0.2;
    filter: brightness(0) invert(1) opacity(0.7);
  }
  .status.online{ 
    opacity: 1;
    filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
  }


  




  </style>
</head>
<body>
  <div class="stage">
    <div class="watch" id="watch">
      <div class="carousel" id="carousel" style="transform:translateX(0)">
        <section class="page" aria-label="Home">
          <div class="title">Break Real</div>
          <div class="statusBar">
            <img id="iconWifi" class="status" src="./assets/icons/wifi.png" alt="WiFi"/>
            <img id="iconServer" class="status" src="./assets/icons/connection.png" alt="Server"/>
          </div>
          <div class="bottles">
            <div id="bottle7" class="bottle full"></div>
            <div id="bottle6" class="bottle empty"></div>
            <div id="bottle5" class="bottle full"></div>
            <div id="bottle4" class="bottle full"></div>
            <div id="bottle3" class="bottle full"></div>
            <div id="bottle2" class="bottle empty"></div>
            <div id="bottle1" class="bottle empty"></div>
          </div>
          <div class="waterTank" title="waterTank" id="waterTank">
            <img src="./assets/waterTank.png" alt="waterTank icon"/>
          </div>
        </section>

        <section class="page" aria-label="Settings">
          <div class="title">Settings</div>
          <div class="panel">
            <button class="btn-xl" id="btnClean">
              <img src="./assets/icons/clean.png" alt="self clean"/> Self-Clean
            </button>
            <div class="list">
              <div class="row">
                <div class="label"><img src="./assets/icons/volume.png" alt="volume"/>Volume</div>
                <input id="rangeVolume" type="range" min="0" max="100" value="60" />
                <div class="val" id="valVolume">60%</div>
              </div>
              <div class="row">
                <div class="label"><img src="./assets/icons/snowflake.png" alt="fridge"/>Fridge</div>
                <div class="switch on" id="swFridge" role="switch" aria-checked="true"></div>
              </div>
              <div class="row">
                <div class="label"><img src="./assets/icons/thermometer.png" alt="temperature"/>Fridge Temperature</div>
                <input id="rangeTemp" type="range" min="3" max="10" value="5" />
                <div class="val" id="valTemp">5</div>
              </div>
              <div class="row">
                <div class="label"><img src="./assets/icons/lightbulb.png" alt="led"/>LED</div>
                <div class="switch on" id="swLed" role="switch" aria-checked="true"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="dots" aria-hidden="true">
        <div class="dot active" id="dot0"></div>
        <div class="dot" id="dot1"></div>
      </div>
    </div>
  </div>
  <script>
    function getQueryParam (name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
  
    const hw = getQueryParam('hw') || 'v1';   // default
    if (hw === "v2") {
      console.log('Detected hardware version v2, applying bottle reverse layout.');
      document.querySelector(".bottles").classList.add("reverse");
    } else {
      console.log('Detected hardware version v1.');
    }

    // ====== æ»‘åŠ¨/åˆ‡é¡µé€»è¾‘ ======
    const carousel = document.getElementById('carousel');
    const watch = document.getElementById('watch');
    const dots = [document.getElementById('dot0'), document.getElementById('dot1')].filter(Boolean);
    let page = 0; // å½“å‰é¡µ 0/1
    // const SWIPE_THRESHOLD = 300; // è§¦å‘åˆ‡é¡µé˜ˆå€¼(px)
    const INERTIA = 0.25; // æƒ¯æ€§æƒé‡

    function go(p){
      page = Math.max(0, Math.min(1, p));
      const x = -page * watch.offsetWidth;
      carousel.style.transition = 'transform .42s cubic-bezier(.22,.61,.36,1)';
      carousel.style.transform = `translateX(${x}px)`;
      dots.forEach((d,i)=> d && d.classList.toggle('active', i===page));
    }

    // é”®ç›˜å·¦å³é”®
    window.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight') go(page+1);
      if(e.key==='ArrowLeft')  go(page-1);
    });

    // è§¦æ§/é¼ æ ‡æ‹–æ‹½
// ====== è§¦æ§/é¼ æ ‡æ‹–æ‹½ï¼ˆå¢å¼ºç‰ˆï¼Œé¿å… slider è¯¯è§¦ï¼‰ ======
// ====== è§¦æ§/é¼ æ ‡æ‹–æ‹½ï¼ˆæ›´ç¨³ï¼šè§’åº¦è¿‡æ»¤ + è¾¹ç¼˜èµ·å§‹ + æ— æƒ¯æ€§ï¼‰ ======
  let startX = 0, startY = 0, atX = 0, dragging = false;
  let swipeDisabled = false;     // ç‚¹åˆ° slider æ—¶ç¦ç”¨ç¿»é¡µ
  let swipeEligible = false;     // æ»¡è¶³è§’åº¦/èµ·å§‹æ¡ä»¶åæ‰å…è®¸æ‹–åŠ¨ç¿»é¡µ

  // å¯è°ƒå‚æ•°
  const SWIPE_THRESHOLD = 220;   // éœ€è¦æ¨ªå‘ä½ç§»è¾¾åˆ° 220px æ‰ç¿»é¡µï¼ˆä½ å¯ç»§ç»­è°ƒå¤§/è°ƒå°ï¼‰
  const H_GUARD = 30;            // æ¨ªå‘ä½ç§»è¶…è¿‡ 16px æ‰è¿›å…¥åˆ¤å®š
  const ANGLE_MAX_DEG = 25;      // æ°´å¹³è§’åº¦å®¹å·®ï¼ˆè¶Šå°è¶Šä¸¥æ ¼ï¼‰
  const EDGE_ONLY = true;        // ä»…å…è®¸ä»å·¦å³è¾¹ç¼˜èµ·æ‰‹åŠ¿
  const EDGE_GUTTER = 60;        // è¾¹ç¼˜åŒºåŸŸå®½åº¦ï¼ˆpxï¼‰ï¼ŒEDGE_ONLY=true æ—¶æ‰ç”Ÿæ•ˆ

  function isInsideSlider(target) {
    return target && target.tagName === 'INPUT' && target.type === 'range';
  }
  function angleIsHorizontal(dx, dy) {
    const ang = Math.atan2(Math.abs(dy), Math.abs(dx)) * 180 / Math.PI;
    return ang <= ANGLE_MAX_DEG;
  }
  function startedAtEdge(x, w) {
    return (x <= EDGE_GUTTER) || (x >= w - EDGE_GUTTER);
  }

  function onDown(e){
    const pt = e.touches ? e.touches[0] : e;
    const hit = e.target; // ç”¨äº‹ä»¶çš„ target æ›´ç¨³
    if (isInsideSlider(hit)) { swipeDisabled = true; return; }
  
    swipeDisabled = false;

    // 2) è¾¹ç¼˜èµ·æ‰‹ï¼ˆå¯é€‰ï¼‰
    const w = watch.offsetWidth;
    if (EDGE_ONLY && !startedAtEdge(pt.clientX, w)) {
      swipeEligible = false; // ä¸­é—´åŒºåŸŸä¸å…è®¸ç¿»é¡µ
    } else {
      swipeEligible = null;  // æœªå†³çŠ¶æ€ï¼Œç­‰ä½ç§»/è§’åº¦è¾¾æ ‡å†ç½®ä¸º true
    }

    dragging = true;
    startX = atX = pt.clientX;
    startY = pt.clientY;
    carousel.style.transition = 'none';
  }

  function onMove(e) {
    if (!dragging || swipeDisabled) return;
    const pt = e.touches ? e.touches[0] : e;
    const dx = pt.clientX - startX;
    const dy = pt.clientY - startY;

    // è¿˜æ²¡èµ„æ ¼ï¼Ÿå…ˆæ£€æŸ¥æ¨ªå‘æŠ¤æ ä¸è§’åº¦
    if (swipeEligible !== true) {
      if (Math.abs(dx) < H_GUARD) return;               // æ¨ªå‘ä½ç§»ä¸å¤Ÿ
      if (!angleIsHorizontal(dx, dy)) {                 // è§’åº¦ä¸æ°´å¹³ï¼šæ”¾å¼ƒç¿»é¡µ
        swipeEligible = false; 
        return;
      }
      // é€šè¿‡åˆç­›
      swipeEligible = true;
    }

    atX = pt.clientX;
    const base = -page * watch.offsetWidth;
    const offset = base + dx;
    carousel.style.transform = `translateX(${offset}px)`;
  }

  function onUp() {
    if (swipeDisabled) { swipeDisabled = false; return; }
    if (!dragging) return;
    dragging = false;
    carousel.style.transition = '';

    if (swipeEligible === true) {
      const totalX = atX - startX;
      if (totalX <= -SWIPE_THRESHOLD)      go(page + 1);
      else if (totalX >= SWIPE_THRESHOLD)  go(page - 1);
      else                                  go(page);  // å›å¼¹
    } else {
      // ä¸ç¬¦åˆæ¡ä»¶ï¼Œç›´æ¥å›å¼¹
      go(page);
    }
    swipeEligible = false;
  }

  // äº‹ä»¶ç»‘å®š
  watch.addEventListener('mousedown', onDown);
  watch.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
  watch.addEventListener('touchstart', onDown, { passive: true });
  watch.addEventListener('touchmove',  onMove, { passive: true });
  watch.addEventListener('touchend',   onUp);


    // ====== è®¾ç½®é¡µæ§ä»¶ï¼ˆå¯é€‰ï¼‰ ======
    function paintRange(el){ if(!el) return; el.style.setProperty('--p', `${(el.value-el.min)/(el.max-el.min)*100}%`); }
    const rngVol = document.getElementById('rangeVolume');
    const valVol = document.getElementById('valVolume');
    const rngTemp= document.getElementById('rangeTemp');
    const valTemp= document.getElementById('valTemp');
    [rngVol,rngTemp].forEach(r=>{ if(!r) return; paintRange(r); r.addEventListener('input',()=>{ paintRange(r); if(r===rngVol && valVol) valVol.textContent=r.value+'%'; if(r===rngTemp && valTemp) valTemp.textContent=r.value; }); });
    if (rngTemp && valTemp) {
      paintRange(rngTemp);
      valTemp.textContent = `${rngTemp.value} Â°C`;

      rngTemp.addEventListener("input", () => {
        paintRange(rngTemp);
        valTemp.textContent = `${rngTemp.value} Â°C`;
      });
    }


    // åˆå§‹å®šä½åˆ°ç¬¬ä¸€é¡µ
    go(0);

    // ====== å¯åŠ¨è§†é¢‘æ’­æ”¾ + é¦–é¡µæ·¡å…¥ ======
    function showHomeWithFade() {
      const startupVideo = document.getElementById('startupVideo');
      const watchEl = document.getElementById('watch');

      // ç¡®ä¿åˆ‡åˆ°é¦–é¡µ
      go(0);

      // é¦–é¡µæ·¡å…¥
      if (watchEl) {
        watchEl.style.opacity = '1';
      }

      // å¯åŠ¨è§†é¢‘æ·¡å‡ºåéšè—
      if (startupVideo) {
        startupVideo.style.transition = 'opacity .6s ease-out';
        startupVideo.style.opacity = '0';
        setTimeout(() => {
          startupVideo.style.display = 'none';
        }, 600);
      }
    }

    function playStartupVideo() {
      const startupVideo = document.getElementById('startupVideo');
      if (!startupVideo) {
        console.warn('âš ï¸ Startup video element not found, retrying...');
        // Retry after a short delay if element not found
        setTimeout(playStartupVideo, 100);
        return;
      }

      // Show the video
      startupVideo.style.display = 'block';
      
      // Ensure video is ready to play
      if (startupVideo.readyState >= 2) {
        // Video is loaded enough to play
        startPlayback();
      } else {
        // Wait for video to load
        startupVideo.addEventListener('loadeddata', startPlayback, { once: true });
        startupVideo.addEventListener('canplay', startPlayback, { once: true });
        // Also try to load it explicitly
        startupVideo.load();
      }

      function startPlayback() {
        // Play the video
        const playPromise = startupVideo.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              console.log('ğŸ¬ Startup video playing...');
            })
            .catch(err => {
              console.warn('âš ï¸ Autoplay blocked, trying muted:', err);
              // Video is already muted, but try again
              startupVideo.muted = true;
              startupVideo.play().catch(e => {
                console.error('âŒ Failed to play startup video:', e);
                // If still fails, just go to home page
                showHomeWithFade();
              });
            });
        }
      }

      // When video ends, hide it and go to home page with fade
      startupVideo.onended = function() {
        console.log('ğŸ“¹ Startup video finished, going to home page...');
        showHomeWithFade();
      };

      // Handle video errors
      startupVideo.onerror = function() {
        console.error('âŒ Startup video failed to load');
        showHomeWithFade();
      };
    }

    // Wait for DOM to be ready before playing startup video
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', playStartupVideo);
    } else {
      // DOM is already ready
      playStartupVideo();
    }

/** === WebSocket ä¸ä¸²å£æ¡¥ ===
 *  æ”¶åˆ°ä¸¤å­—èŠ‚ï¼š [id, value]
 *    id = 0x01..0x07 å¯¹åº” 1..7 å·ç“¶
 *    value = 0xFF â†’ fullï¼›0x00 â†’ empty
 *  å‘é€ä¸¤å­—èŠ‚ï¼šå¦‚ [0x02,0xFF] è¡¨ç¤º"æŒ‰é’®è¢«æŒ‰"
 */

// WebSocket connection - moved outside IIFE
// Auto-detect WebSocket URL based on current page location
function getWebSocketURL() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  let hostname = window.location.hostname;
  
  // Fallback to localhost if hostname is empty or undefined
  if (!hostname || hostname === '') {
    hostname = 'localhost';
  }
  
  const port = '8080';
  return `${protocol}//${hostname}:${port}`;
}

const WS_URL = getWebSocketURL();
let ws; // Declared in global scope
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;
const RECONNECT_DELAY = 2000; // 2 seconds

// Debug information
console.log('ğŸ” WebSocket URL Debug Info:');
console.log('   window.location.hostname:', window.location.hostname);
console.log('   window.location.protocol:', window.location.protocol);
console.log('   window.location.host:', window.location.host);
console.log('   Constructed WS_URL:', WS_URL);

function connect(){
  console.log(`Attempting to connect to WebSocket at: ${WS_URL}`);
  
  // Validate WebSocket URL before attempting connection
  if (!WS_URL || WS_URL.includes('://:') || WS_URL.includes('://undefined')) {
    console.error('âŒ Invalid WebSocket URL detected:', WS_URL);
    console.error('   This usually happens when accessing the page via file:// protocol');
    console.error('   Please access the page via HTTP server (http://localhost:3000)');
    return;
  }
  
  ws = new WebSocket(WS_URL);
  ws.binaryType = 'arraybuffer';
  
  // Make ws globally available
  window.ws = ws;
  
  ws.onopen = () => {
    console.log("âœ… WebSocket connected successfully");
    reconnectAttempts = 0; // Reset reconnect counter on successful connection
    // Send a simple startup notification to the device/server
    try {
      const startupBytes = new Uint8Array([0x0F, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xAA]);
      ws.send(startupBytes);
    } catch (e) {
      console.warn('âš ï¸ Failed to send startup message:', e);
    }
  };
  
  ws.onmessage = (e) => {
    console.log("ğŸ“¨ From device:", e.data);
    
    try {
      // Try to parse as JSON first (structured messages)
      const message = JSON.parse(e.data);
      
      if (message.type === 'bottle_status') {
        updateBottleStatus(message.bottleId, message.status);
        console.log(`ğŸ¾ Updated bottle ${message.bottleId} to ${message.status}`);
      } else if (message.type === 'module_status') {
        handleModuleStatus(message.module, message.status);
        console.log(`ğŸ”§ Module ${message.module} status: ${message.status}`);
      } 
    } catch (error) {
      // If not JSON, treat as raw hex data
      console.log("ğŸ“¨ Raw hex data:", e.data);
    }
  };
  
  ws.onclose = (event) => {
    console.log(`ğŸ”Œ WebSocket closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`);
    
    // Attempt to reconnect if not a normal closure
    if (event.code !== 1000 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
      reconnectAttempts++;
      console.log(`ğŸ”„ Attempting to reconnect (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}) in ${RECONNECT_DELAY}ms...`);
      setTimeout(connect, RECONNECT_DELAY);
    } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
      console.error("âŒ Max reconnection attempts reached. Please check your connection.");
    }
  };
  
  ws.onerror = (error) => {
    console.error("âŒ WebSocket error:", error);
    console.error("   Make sure the server is running and accessible");
    console.error(`   Expected URL: ${WS_URL}`);
  };
}

// Start connection
connect();

// === Status icons helpers ===
function setWifiStatus(isOnline){
  const el = document.getElementById('iconWifi');
  if (!el) return;
  el.classList.toggle('online', isOnline);
}
function setServerStatus(isOnline){
  const el = document.getElementById('iconServer');
  if (!el) return;
  el.classList.toggle('online', isOnline);
}

// Function to update bottle status based on serial message
function updateBottleStatus(bottleId, status) {
  const bottleElement = document.getElementById(`bottle${bottleId}`);
  if (!bottleElement) {
    console.warn(`âš ï¸ Bottle element not found: bottle${bottleId}`);
    return;
  }
  
  // Remove existing classes
  bottleElement.classList.remove('full', 'empty');
  
  // Add the appropriate class
  bottleElement.classList.add(status);
  
  console.log(`ğŸ¾ Bottle ${bottleId} updated to ${status}`);
}

// Function to handle module status messages
function handleModuleStatus(module, status) {
  console.log(`ğŸ”§ Module ${module} status update: ${status}`);
  
  // You can add logic here to update UI based on module status
  // For example, update LEDs, buttons, or indicators
  
  switch(module) {
    case 'voice':
      // Handle voice module status
      console.log(`ğŸ¤ Voice module status: ${status}`);
      break;
    case 'clean':
      // Handle clean module status
      console.log(`ğŸ§¹ Clean module status: ${status}`);
      break;
    case 'pouring':
      // Handle pouring module status
      console.log(`ğŸ’§ Pouring module status: ${status}`);
      
      // Convert status to number if it's a string
      const statusNum = typeof status === 'number' ? status : parseInt(status, 10);
      
      if (statusNum === 1) {
        console.log('ğŸ¬ Playing pour start video...');
        playVideo('start');
      } else if (statusNum === 0) {
        console.log('ğŸ¬ Playing pour finish video...');
        playVideo('end');
        // go(0) will be called automatically when video finishes (via onended handler)
      }
      break;
    case "wifi":
      // Handle wifi module status
      console.log(`ğŸŒ Wifi module status: ${status}`);
      setWifiStatus(status === 1);
      break;
    case "server":
      // Handle server module status
      console.log(`ğŸŒ Server module status: ${status}`);
      setServerStatus(status === 1);
      break;
    default:
      console.log(`â“ Unknown module: ${module}`);
  }
}

    // ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼šå‘ä¸²å£å‘é€ä¸¤å­—èŠ‚
function sendBytes(b0, b1){
  if (!ws || ws.readyState !== 1) return console.warn('WS not ready');
  const buf = new Uint8Array([b0, b1]);
  ws.send(buf);
}




// === æŒ‡ä»¤å¸¸é‡ï¼ˆæŒ‰ä½ ç¤ºä¾‹ï¼Œå¯éšæ—¶è°ƒæ•´æ•°å€¼ï¼‰ ===
const DEV = {
  MACHINE: 0X00,
  BOTTLE: 0X01,
  FRIDGE: 0x02, // å†°ç®±
  LED:    0x03, // â† è¿™é‡Œå…ˆå ç”¨ 0x03ï¼ˆè‹¥ä½ æœ‰æ—¢å®šå€¼ï¼Œæ”¹è¿™é‡Œå³å¯ï¼‰
  ALCOHOL: 0X04
  
};

// ä¸€äº›æ“ä½œç ï¼ˆä¾æ®ä½ ç¤ºä¾‹æŠŠâ€œç”µæºå¼€æœº=0x02â€ï¼‰
const OP = {
  FRIDGE_ON:  0x02,
  FRIDGE_OFF: 0x00,
  SELF_CLEAN: 0x01,
  LED_OFF: 0X00,
  LED_ON: 0X02
};

const STATUS = {
  CLEAN_START : 0X01,
  CLEAN_END : 0X00
};

// ç»Ÿä¸€ç»„å¸§ï¼š0x0F, 0x00, device, 0x00, op, 0x00, value, 0xAA
function buildFrame(device, op, value){
  const v = value ?? 0x00;
  return new Uint8Array([0x0F, 0x00, device & 0xFF, 0x00, op & 0xFF, 0x00, v & 0xFF, 0xAA]);
}

function sendFrame(device, op, value){
  if (!ws || ws.readyState !== 1) {
    console.warn('WS not ready');
    return;
  }
  ws.send(buildFrame(device, op, value));
}

// ====== æ§ä»¶ç»‘å®šï¼šåˆ†åˆ«å‘é€ä¸åŒçš„ä»£ç  ======

// è‡ªæ¸…æ´ï¼šç‚¹å‡»å³å‘ï¼ˆè®¾å¤‡= CLEANï¼Œæ“ä½œ= TRIGGERï¼Œå€¼= 0x01ï¼‰
document.getElementById('btnClean')?.addEventListener('click', ()=>{
  sendFrame(DEV.MACHINE, OP.SELF_CLEAN, STATUS.CLEAN_START);
});

// Fridge å¼€å…³ï¼šå¼€= POWER_ONï¼Œå…³= POWER_OFFï¼›æ¸©åº¦å¦å‘ä¸€å¸§ï¼ˆæˆ–ä½ ä¹Ÿå¯ä»¥ä¸€æ¬¡å¸§é‡Œå¸¦æ¸©åº¦ï¼‰
document.getElementById('swFridge')?.addEventListener('click', ()=>{
  const swFridge = document.getElementById('swFridge');
  const on = swFridge.classList.toggle('on');
  swFridge.setAttribute('aria-checked', String(on));
  const isFridgeOn = swFridge.classList.contains('on');
  let t = Math.max(3, Math.min(10, parseInt(rngTemp.value || '3', 10)));
  sendFrame(DEV.FRIDGE, isFridgeOn ? OP.FRIDGE_ON : OP.FRIDGE_OFF, t);
});

// LED å¼€å…³ï¼šç”¨ç›¸åŒ POWER_ON/OFF è¯­ä¹‰
document.getElementById('swLed')?.addEventListener('click', ()=>{
  const swLed = document.getElementById('swLed');
  const on = swLed.classList.toggle('on');
  swLed.setAttribute('aria-checked', String(on));
  sendFrame(DEV.LED, on ? OP.LED_ON : OP.LED_OFF, 0x00);
});

// éŸ³é‡ï¼š0~100ï¼Œå»ºè®®åœ¨ change æ—¶å‘é€ï¼ˆæ¾æ‰‹å†å‘ï¼‰
document.getElementById('rangeVolume')?.addEventListener('change', ()=>{
  let v = Math.max(0, Math.min(100, parseInt(rngVol.value || '0', 10)));
  sendFrame(DEV.VOLUME, 0x00, v);
});

// å†°ç®±æ¸©åº¦ï¼š3~10 â„ƒï¼Œå•ç‹¬ä¸€å¸§ï¼ˆæˆ–ä½ ä¹Ÿå¯ä»¥åœ¨å¼€æœºé‚£å¸§é‡ŒåŒæ—¶å¸¦å…¥ï¼‰
document.getElementById('rangeTemp')?.addEventListener('change', ()=>{
  let t = Math.max(3, Math.min(10, parseInt(rngTemp.value || '3', 10)));
  // æ–¹å¼ä¸€ï¼ˆæ¨èæ¸…æ™°ï¼‰ï¼šå•ç‹¬ä½¿ç”¨ TEMP è®¾å¤‡ç ï¼š
  const isFridgeOn = document.getElementById('swFridge')?.classList.contains('on');
  sendFrame(DEV.FRIDGE, isFridgeOn ? OP.FRIDGE_ON : OP.FRIDGE_OFF, t);

});


function throttle(fn, gap=100){
  let last=0, timer=null;
  return function(...args){
    const now=Date.now();
    if(now-last>=gap){ last=now; fn.apply(this,args); }
    else{ clearTimeout(timer); timer=setTimeout(()=>{ last=Date.now(); fn.apply(this,args); }, gap-(now-last)); }
  }
}

function playVideo(msg) {
  let videoId;
  if (msg === "start") {
    videoId = "pourStartVideo";
  } else if (msg === "end") {
    videoId = "pourFinishVideo";
  } else {
    // Default or error case
    console.error(`Unknown msg: ${msg}`);
    return;
  }
  const el = document.getElementById(videoId);
  if (!el) {
    console.error(`âŒ Video element not found: ${videoId}`);
    return;
  }

  // If playing finish video, stop the looping pouring video first
  if (msg === "end") {
    const pouringEl = document.getElementById("pouringVideo");
    if (pouringEl) {
      pouringEl.pause();
      pouringEl.loop = false;
      pouringEl.style.display = 'none';
    }
  }

  // No need to set src since it's already in the HTML
  
  // Show the video element
  el.style.display = 'block';
  el.style.width = '100%';
  el.style.height = '100%';
  
  // Remove existing event listeners to prevent duplicates
  el.onended = null;
  
  // Add event listener to return to home page when video finishes
  const pouringEl = document.getElementById("pouringVideo");

  el.onended = function() {
    // Video chaining logic for "pourStartVideo" and "pourFinish"
    if (el.id === "pourStartVideo") {
      if (pouringEl) {
        pouringEl.style.display = 'block';
        pouringEl.style.width = '100%';
        pouringEl.style.height = '100%';
        pouringEl.loop = true;
        pouringEl.currentTime = 0;
        pouringEl.play().catch(err => {
          // Autoplay blocked, try muting
        pouringEl.muted = true;
        pouringEl.play().catch(() => {});
        });
        el.style.display = 'none';
      }
      // Do NOT execute the rest of this onended handler for pourStartVideo
      return;
    } else if (el.id === "pourFinishVideo") {
      pouringEl.loop = false;
      pouringEl.style.display = 'none';
      console.log('ğŸ“¹ Video finished playing, returning to home page...');
      // Hide the video
      el.style.display = 'none';
      go(0); // Go to page 0 (home page)
      return; // Exit early to prevent falling through
    }
    // console.log('ğŸ“¹ Video finished playing, returning to home page...');
    // // Hide the video
    // el.style.display = 'none';
    // go(0); // Go to page 0 (home page)
  };
  
  // Add error handler in case video fails to load
  el.onerror = function() {
    console.error('âŒ Video failed to load:', videoId);
    console.log('ğŸ“¹ Returning to home page due to video error...');
    // Hide the video
    el.style.display = 'none';
    go(0); // Go to home page even if video fails
  };
  
  // è‹¥éœ€è¦å£°éŸ³ï¼šæŠŠ muted å…³æ‰ï¼ˆè§è‡ªåŠ¨æ’­æ”¾ç­–ç•¥ï¼‰
  // el.muted = false;

  const p = el.play();
  if (p && typeof p.catch === 'function') {
    p.catch(err => {
      console.warn('Autoplay blocked:', err);
      // æ–¹æ¡ˆAï¼šé™éŸ³å†è¯•
      el.muted = true;
      el.play().catch(e2 => {
        console.warn('Still blocked, waiting for user gestureâ€¦', e2);
        // If still blocked, just return to home page
        console.log('ğŸ“¹ Returning to home page...');
        el.style.display = 'none';
        go(0);
      });
    });
  }
}

// === Stealth Exit: Long-press on title to show green screen ===
(function() {
  const titleEl = document.querySelector('.title');
  if (!titleEl) return;
  
  let pressTimer = null;
  const EXIT_PRESS_DURATION = 2000; // 3 seconds
  
  // Create green screen overlay (image)
  const greenScreen = document.createElement('img');
  greenScreen.id = 'greenScreen';
  greenScreen.src = './assets/green2.png';
  greenScreen.alt = 'Green Screen';
  greenScreen.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:99999; display:none; background:#000;';
  document.body.appendChild(greenScreen);
  
  function showGreenScreen() {
    console.log('ğŸŸ¢ Green screen activated');
    greenScreen.style.display = 'block';
  }
  
  function startPressTimer(e) {
    pressTimer = setTimeout(() => {
      showGreenScreen();
    }, EXIT_PRESS_DURATION);
  }
  
  function cancelPressTimer() {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
    }
  }
  
  // Touch events (for touchscreens)
  titleEl.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startPressTimer(e);
  }, { passive: false });
  
  titleEl.addEventListener('touchend', (e) => {
    e.preventDefault();
    cancelPressTimer();
  }, { passive: false });
  
  titleEl.addEventListener('touchmove', (e) => {
    e.preventDefault();
    cancelPressTimer();
  }, { passive: false });
  
  // Mouse events (for mouse/trackpad)
  titleEl.addEventListener('mousedown', (e) => {
    startPressTimer(e);
  });
  
  titleEl.addEventListener('mouseup', (e) => {
    cancelPressTimer();
  });
  
  titleEl.addEventListener('mouseleave', (e) => {
    cancelPressTimer();
  });
})();

  </script>

<video id="startupVideo"
       src="./assets/startup.mp4"
       playsinline
       preload="auto"
       autoplay
       muted
       style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:10000; background:#000; display:block;">
</video>

<video id="pourStartVideo"
       src="./assets/pour_start.mp4"
       playsinline
       preload="auto"
       muted
       style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background:#000; display:none;">
</video>

<video id="pouringVideo"
       src="./assets/pouring.mp4"
       playsinline
       preload="auto"
       muted
       style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background:#000; display:none;">
</video>

<video id="pourFinishVideo"
       src="./assets/pour_finish.mp4"
       playsinline
       preload="auto"
       muted
       style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background:#000; display:none;">
</video>

</body>
</html>


